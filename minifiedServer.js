var{isArray:a}=Array,b=require('express'),c=require('request'),d=require('slugify'),e=require('xss'),f=require('bcrypt'),g=require('multer'),h=g.diskStorage({destination:function(A,_,B){B(null,'static/uploads')},filename:function(C,_b,_c){const D=_b.originalname.split('.').pop(),F=E.toISOString();const E=new Date();_c(null,`${C.session.users}${F}.${D}`)}}),i=g({storage:h}),j=b(),{MongoClient:k,ServerApiVersion:l,ObjectId:m}=require('mongodb');require('dotenv').config();j.use(b.urlencoded({extended:!0})).use('/static',b.static('static')).use(require('express-session')({secret:process.env.SESSION_KEY,resave:!1,saveUninitialized:!1})).set('view engine','ejs').set('views','view').listen(3000,()=>console.log('Server is running on port 3000'));var n=`${process.env.MONGODB_URL}`;var o=new k(n, {serverApi:{version:l.v1,strict:!0,deprecationErrors:!0}});o.connect().then(()=>console.log('Database connection established')).catch(_a=>{console.log(`Database connection error - ${_a}`);console.log(`For uri - ${n}`)});j.get('/',(_A,_B)=>{_B.render('homepage.ejs');console.log(_A.session.users)});j.get('/overview',(aA,aB)=>{if(aA.session.users==void 0)aB.redirect('/login');else{var _C=require('request'),_d=process.env.API_KEY,_e={28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',99:'Documentary',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Science Fiction',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'},_f=aA.session.users,G=o.db(process.env.MONGODB_NAME),H=G.collection(process.env.MONGODB_COLLECTION),I=async ()=>{try {const aC=await H.findOne({_id:new m(_f)});const aD=aC.genre,aE=aC.rating;return{genreArray:aD,userRating:aE}} catch (aF) {console.error('Failed to retrieve favorites:',aF)}};I().then(({genreArray:aG,userRating:aH})=>_C({method:'GET', url:`https://api.themoviedb.org/3/discover/movie?api_key=process.env.API_KEY&language=en-US&sort_by=popularity.desc&vote_average.gte=${aH}&with_genres=${aG}`, qs:{language:'en-US',page:1}, headers:{accept:'application/json',Authorization:`Bearer ${_d}`}},function(aI,aJ,aK){if(aI)throw Error(aI);var _D=JSON.parse(aK).results,_E=[],_F=[],_g=[],_h=[],_i=[],J=[],K=[],L=[],M=[],N=[],O=[],p=[],q=[],r=[],s=[];for(const aT of _D){var t=aT.adult,u=aT.backdrop_path,v=aT.genre_ids.map(aU=>_e[aU]),w=aT.id,x=aT.original_language,y=aT.original_title,z=aT.overview,aL=aT.popularity,aM=aT.poster_path,aN=aT.release_date,aO=aT.title,aP=d(aT.title,{replacement:'-',remove:/[*+~.,()'"!:@]/g,lower:!0,strict:!1,locale:'en',trim:!0}),aQ=aT.video,aR=aT.vote_average,aS=aT.vote_count;_E.push(t);_F.push(u);_g.push(v);_h.push(w);_i.push(x);J.push(y);K.push(z);L.push(aL);M.push(aM);N.push(aN);O.push(aO);p.push(aP);q.push(aQ);r.push(aR);s.push(aS)}aB.render('overview.ejs',{adultArray:_E,backdropPathArray:_F,genreIdsArray:_g,idArray:_h,originalLanguageArray:_i,originalTitleArray:J,overviewArray:K,popularityArray:L,posterPathArray:M,releaseDateArray:N,titleArray:O,videoArray:q,voteAverageArray:r,voteCountArray:s,urlTitleArray:p})}))}});j.get('/overview/all',(aV,aW)=>{if(aV.session.users==void 0)aW.redirect('/login');else{var aX=require('request'),aY=process.env.API_KEY,aZ=aV.session.users,bA=o.db(process.env.MONGODB_NAME),_G=bA.collection(process.env.MONGODB_COLLECTION),_H=async ()=>{try {const bB=await _G.findOne({_id:new m(aZ)});const bC=bB.genre,bD=bB.rating;return{genreArray:bC,userRating:bD}} catch (bE) {console.error('Failed to retrieve favorites:',bE)}};_H().then(({genreArray:bF,userRating:bG})=>{var bH=[],bI=[],bJ=[],bK=[],bL=[],bM=[],_I=[],_j=[],_k=[],_l=[],_m=[],_n=[],_o=[],P=[],Q=[];let R=1;function S(){aX({method:'GET', url:`https://api.themoviedb.org/3/discover/movie?api_key=process.env.API_KEY&language=en-US&sort_by=popularity.desc&vote_average.gte=${bG}&with_genres=${bF}`, qs:{language:'en-US',page:R}, headers:{accept:'application/json',Authorization:`Bearer ${aY}`}},function(bN,bO,bP){if(bN)throw Error(bN);var bQ=JSON.parse(bP).results;for(const bS of bQ){bH.push(bS.adult);bI.push(bS.backdrop_path);bJ.push(bS.genre_ids);bK.push(bS.id);bL.push(bS.original_language);bM.push(bS.original_title);_I.push(bS.overview);_j.push(bS.popularity);_k.push(bS.poster_path);_l.push(bS.release_date);_m.push(bS.title);_n.push(bS.video);_o.push(bS.vote_average);P.push(bS.vote_count);var bR=d(bS.title,{replacement:'-',remove:/[*+~.,()'"!:@]/g,lower:!0,strict:!1,locale:'en',trim:!0});Q.push(bR)}R++;R<=10?S():T()})}function T(){aW.render('overviewAll.ejs',{adultArray:bH,backdropPathArray:bI,genreIdsArray:bJ,idArray:bK,originalLanguageArray:bL,originalTitleArray:bM,overviewArray:_I,popularityArray:_j,posterPathArray:_k,releaseDateArray:_l,titleArray:_m,videoArray:_n,voteAverageArray:_o,voteCountArray:P,urlTitleArray:Q})}S()})}});j.get('/favourites',(bT,bU)=>{if(bT.session.users==void 0)bU.redirect('/login');else{var bV=bT.session.users,bW=o.db(process.env.MONGODB_NAME),bX=bW.collection(process.env.MONGODB_COLLECTION),bY=async ()=>{try {const bZ=await bX.findOne({_id:new m(bV)});return bZ.favorites||[]} catch (cA) {console.error('Failed to retrieve favorites:',cA);return[]}};bY().then(cB=>{var cC=[],cD=[],cE=[],cG=cB.length;let cF=0;!cG&&bU.render('favourites.ejs',{idArray:cC,posterPathArray:cD,titleArray:cE});for(const cJ of cB){var cH=process.env.API_KEY,cI={method:'GET',url:`https://api.themoviedb.org/3/movie/${cJ}?language=en-US`,qs:{language:'en-US',page:1},headers:{accept:'application/json',Authorization:`Bearer ${cH}`}};c(cI,function(cK,cL,cM){if(cK){console.error('Error fetching movie data:',cK);return}var cN=JSON.parse(cM);cC.push(cN.id);cD.push(cN.poster_path);cE.push(cN.title);cF++;cF==cG&&bU.render('favourites.ejs',{idArray:cC,posterPathArray:cD,titleArray:cE})})}}).catch(cO=>{console.error('Error while retrieving favorites:',cO);bU.status(500).send('Internal server error')})}});j.get('/signup',(cP,cQ)=>{cQ.render('signup.ejs');console.log(cP.session.users)});j.get('/signup/preferences',(cR,cS)=>{cS.render('signup-preferences.ejs');console.log(cR.session.users)});j.get('/login',(cT,cU)=>{cU.render('login.ejs');console.log(cT.session.users)});j.get('/profile',(cV,cW)=>{if(cV.session.users==void 0)cW.redirect('/login');else{var cX=cV.session.users,cY=o.db(process.env.MONGODB_NAME),cZ=cY.collection(process.env.MONGODB_COLLECTION),dA=async ()=>{try {const dB=await cZ.findOne({_id:new m(cX)});const dC=dB.fileName,dD=dB.username,dE=dB.genre,dF=dB.rating;console.log(`dit is de picture filename: ${dC}`);console.log(`dit is de username: ${dD}`);console.log(`dit is de genres: ${dE}`);return{pictureFilename:dC,username:dD,genres:dE,rating:dF}} catch (dG) {console.error('Failed to retrieve favorites:',dG)}};dA().then(({pictureFilename:dH,username:dI,genres:dJ,rating:dK})=>cW.render('profile.ejs',{pictureFilename:dH,username:dI,genres:dJ,rating:dK})).catch(()=>cW.status(500).send('Internal Server Error'));console.log(cV.session.users)}});j.get('/searchmovie',(dL,dM)=>dM.render('searchmovie.ejs'));j.get('/profile/settings',(dN,dO)=>{if(dN.session.users==void 0)dO.redirect('/login');else{var dP=dN.session.users,dQ=o.db(process.env.MONGODB_NAME),dR=dQ.collection(process.env.MONGODB_COLLECTION),dS=async ()=>{try {const dT=await dR.findOne({_id:new m(dP)});const dU=dT.fileName,dV=dT.username,dW=dT.genre,dX=dT.rating;return{pictureFilename:dU,username:dV,genres:dW,rating:dX}} catch (dY) {console.error('Failed to retrieve favorites:',dY)}};dS().then(({pictureFilename:dZ,username:eA,genres:eB,rating:eC})=>dO.render('profile-settings.ejs',{pictureFilename:dZ,username:eA,genres:eB,rating:eC}));console.log(dN.session.users)}});j.post('/profile-picture',i.single('avatar'),async function(eD,eE){var eF=o.db(process.env.MONGODB_NAME),eG=eF.collection(process.env.MONGODB_COLLECTION),eH=eD.body.rating,eI=e(eD.body.username),eJ=eD.body.genre;try {var eK=await eG.findOne({_id:new m(eD.session.users)});var eL={rating:eH,username:eI||eK.username,genre:eJ?(a(eJ)?eJ:[eJ]):eK.genre},_J=eD.file?eD.file.filename:null;_J?eL.fileName=_J:eL.fileName=eK.fileName;if(eI&&eI!==eK.username){var _K=await eG.findOne({username:e(eD.body.username)});if(_K)return eE.render('username-exists.ejs',{initialDetailPageURL:eD.headers.referer})}await eG.findOneAndUpdate({_id:new m(eD.session.users)},{$set:eL});eE.render('profile-updated.ejs',{initialDetailPageURL:eD.headers.referer})} catch (eM) {console.error(eM);eE.status(500).send('Server error')}});j.get('/movie/:name',async (eN,eO)=>{if(eN.session.users==void 0)eO.redirect('/login');else{movieName=eN.params.name;var eQ=`https://api.themoviedb.org/3/search/movie?query=${movieName}&language=en-US`;var eP=process.env.API_KEY,eR={method:'GET',headers:{accept:'application/json',Authorization:`Bearer ${eP}`}};fetch(eQ,eR).then(eS=>eS.json()).then(eT=>{var eU=eT.results[0],eV=eU.genre_ids,eW=[],eX={28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',99:'Documentary',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Science Fiction',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'},eY=eU.id,eZ=eU.overview,fA=eU.poster_path,fB=eU.release_date,fC=eU.title;for(const fD of eV)eW.push(eX[fD]);fetch(`https://api.themoviedb.org/3/movie/${eY}?language=en-US`,{method:'GET',headers:{accept:'application/json',Authorization:`Bearer ${eP}`}}).then(fE=>fE.json()).then(fF=>{var fG=fF.runtime,fH=fF.production_countries[0].name,fI={Algeria:'African',Angola:'African',Benin:'African',Botswana:'African','Burkina Faso':'African',Burundi:'African',Canada:'American','Central African Republic':'African',Comoros:'African',Congo:'African',Djibouti:'African','Equatorial Guinea':'African',Eritrea:'African',Ethiopia:'African',Gabon:'African',Gambia:'African',Ghana:'African',Guinea:'African','Guinea-Bissau':'African','Ivory Coast':'African','Cape Verde':'African',Cameroon:'African',Kenya:'African',Lesotho:'African',Liberia:'African',Madagascar:'African',Malawi:'African',Mali:'African',Mauritania:'African',Mauritius:'African',Mozambique:'African',Namibia:'African',Niger:'African',Nigeria:'African',Uganda:'African',Rwanda:'African','Sao Tome and Principe':'African',Senegal:'African',Seychelles:'African','Sierra Leone':'African',Somalia:'African',Sudan:'African','South Africa':'African','South Sudan':'African',Swaziland:'African',Tanzania:'African',Togo:'African',Chad:'African',Zambia:'African',Zimbabwe:'African',Indonesia:'Asian',Pakistan:'Asian',Bangladesh:'Asian',Philippines:'Asian',Afghanistan:'Asian','Saudi Arabia':'Asian',Uzbekistan:'Asian',Malaysia:'Asian','New Zealand':'Asian',Yemen:'Asian',Nepal:'Asian','Sri Lanka':'Asian',Kazakhstan:'Asian',Syria:'Asian',Cambodia:'Asian',Jordan:'Asian',Azerbaijan:'Asian','United Arab Emirates':'Asian',Tajikistan:'Asian',Laos:'Asian',Kyrgyzstan:'Asian',Turkmenistan:'Asian',Singapore:'Asian',Oman:'Asian','State of Palestine':'Asian',Kuwait:'Asian',Georgia:'Asian',Mongolia:'Asian',Armenia:'Asian',Qatar:'Asian',Bahrain:'Asian',Taiwan:'Asian','Timor-Leste':'Asian','United States of America':'American','United Kingdom':'British','Antigua and Barbuda':'Caribbean','The Bahamas':'Caribbean',Barbados:'caribbean',Cuba:'caribbean',Curaçao:'caribbean',Dominica:'caribbean','Dominican Republic':'caribbean',Grenada:'Caribbean',Haiti:'caribbean',Jamaica:'Caribbean','Saint Kitts and Nevis':'Caribbean','Saint Lucia':'Caribbean','Saint Vincent and the Grenadines':'Caribbean','Trinidad and Tobago':'Caribbean',China:'CHinese',Belarus:'Eastern European',Bulgaria:'Eastern European','Czech Republic':'Eastern European',Estonia:'Eastern European',Hungary:'Eastern European',Latvia:'Eastern European',Lithuania:'Eastern European',Moldova:'Eastern European',Poland:'Eastern European',Romania:'Eastern European',Russia:'Eastern European',Slovakia:'Eastern European',Ukraine:'Eastern European',Andorra:'European',Austria:'European',Belgium:'European',Denmark:'European',Finland:'European',Iceland:'European',Luxembourg:'European',Malta:'European',Monaco:'European',Netherlands:'European',Norway:'European',Portugal:'European','San Marino':'European',Sweden:'European',Switzerland:'European','Vatican City':'European',France:'French',Germany:'German',Greece:'Greek',India:'Indian',Ireland:'Irish',Italy:'Italian',Japan:'Japanese',Israel:'Jewish','South Korea':'Korean','North Korea':'Korean',Argentina:'Latin American',Belize:'Latin American',Bolivia:'Latin American',Brazil:'Latin American',Chile:'Latin American',Colombia:'Latin American','Costa Rica':'Latin American',Ecuador:'Latin American','El Salvador':'Latin American',Guatemala:'Latin American',Guyana:'Latin American',Honduras:'Latin American',Mexico:'Latin American',Nicaragua:'Latin American',Panama:'Latin American',Paraguay:'Latin American',Peru:'Latin American',Suriname:'Latin American',Uruguay:'Latin American',Venezuela:'Latin American',Vietnam:'Vietnamese'};if(fI.hasOwnProperty(fH)){var fJ=fI[fH],fK=process.env.FOOD_API_KEY,fL=~~Math.random()*100;var fM=`https://api.spoonacular.com/recipes/complexSearch?cuisine=${fJ}&number=1&offset=${fL}&apiKey=${fK}`;fetch(fM).then(fN=>{if(!fN.ok)throw Error(`Network response was not ok: ${fN.status}`);return fN.json()}).then(fO=>{var fP=fO.results[0].id,fQ=fO.results[0].title,fR=process.env.FOOD_API_KEY;fetch(`https://api.spoonacular.com/recipes/${fP}/analyzedInstructions?apiKey=${fK}`).then(fS=>{if(!fS.ok)throw Error(`Network response was not ok: ${fS.status}`);return fS.json()}).then(fT=>{var fU=[],fV=[],fW=fT[0].steps;for(const fX of fW){fU.push(fX.number);fV.push(fX.step)}fetch(`https://api.spoonacular.com/recipes/${fP}/ingredientWidget.json?apiKey=${fR}`).then(fY=>{if(!fY.ok)throw Error(`Network response was not ok: ${fY.status}`);return fY.json()}).then(fZ=>{var gA=fZ.ingredients,gB=[],gC=[],gD=[];for(const gE of gA){gB.push(gE.name);gC.push(gE.amount.metric.value);gD.push(gE.amount.metric.unit)}(async ()=>{var gF=eN.session.users,gG=o.db(process.env.MONGODB_NAME),gH=gG.collection(process.env.MONGODB_COLLECTION);try {var gI=await gH.findOne({_id:new m(gF)});var gJ=gI.favorites,gK=gJ.map(gM=>parseInt(gM,10));let gL;gK.includes(eY)?(gL=!0,eO.render('filmdescription.ejs',{movieGenres:eV,movieId:eY,movieOverview:eZ,moviePosterPath:fA,movieReleaseDate:fB,movieTitle:fC,inList:gL,recipeTitle:fQ,stepNumberArray:fU,stepOverviewArray:fV,ingredientNameArray:gB,ingredientValueArray:gC,ingredientUnitArray:gD,movieGenresClean:eW,movieRuntime:fG})):(gL=!1,eO.render('filmdescription.ejs',{movieGenres:eV,movieId:eY,movieOverview:eZ,moviePosterPath:fA,movieReleaseDate:fB,movieTitle:fC,inList:gL,recipeTitle:fQ,stepNumberArray:fU,stepOverviewArray:fV,ingredientNameArray:gB,ingredientValueArray:gC,ingredientUnitArray:gD,movieGenresClean:eW,movieRuntime:fG}))} catch (gN) {console.error('Failed to retrieve favorites:',gN)}})()})})})}else console.log(`Er is geen keukeninformatie beschikbaar voor ${fH}.`)}).catch(gO=>console.error(`error:${gO}`))}).catch(gP=>console.error(`error:${gP}`))}});j.post('/favorite-deleted',(gQ,gR)=>{var gS=gQ.session.users,gT=gQ.body.favoriteBtn,gU=o.db(process.env.MONGODB_NAME),gV=gU.collection(process.env.MONGODB_COLLECTION);(async ()=>{try {var gW=await gV.findOne({_id:new m(gS)});var gX=gW.favorites,gY=gX.filter(gZ=>`${gZ}`!==`${gT}`);await gV.updateOne({_id:new m(gS)},{$set:{favorites:gY}})} catch (hA) {console.error('Failed to retrieve favorites:',hA)}})();gR.render('delete-confirmation.ejs',{initialDetailPageURL:gQ.headers.referer})});j.post('/favorite-added',(hB,hC)=>{var hD=o.db(process.env.MONGODB_NAME);(async ()=>{})();hC.render('add-confirmation.ejs',{initialDetailPageURL:hB.headers.referer})});j.get('/logout',(hE,hF)=>hE.session.destroy(hG=>hG?(console.error(hG),hF.status(500).send('Session destroy failed')):(hF.redirect('/login'))));j.post('/new-user',async (hH,hI)=>{var hJ=o.db(process.env.MONGODB_NAME),hK=hJ.collection(process.env.MONGODB_COLLECTION);try {var hL=await hK.findOne({username:e(hH.body.username)});if(!hL){var hM=10;var hN=await hK.findOne({username:e(hH.body.username)});hH.session.users=hN._id;hI.redirect('/overview')}else hI.render('username-exists.ejs',{initialDetailPageURL:hH.headers.referer})} catch (hO) {console.error(hO);hI.status(500).send('Server error')}});j.post('/login-confirmation',async (hP,hQ)=>{try {var hR=o.db(process.env.MONGODB_NAME),hS=hR.collection(process.env.MONGODB_COLLECTION);var hT=await hS.findOne({username:e(hP.body.username)});if(hT){var hU=await f.compare(hP.body.password,hT.password);hU?(hP.session.users=hT._id,hQ.redirect('/overview'),console.log(hP.session.users)):(hQ.render('invalid-password.ejs',{initialDetailPageURL:hP.headers.referer}))}else hQ.render('user-doenst-exist.ejs',{initialDetailPageURL:hP.headers.referer})} catch (hV) {console.error(hV);hQ.status(500).send('Server error')}});j.get('/search',(hW,hX)=>{if(hW.session.users==void 0)hX.redirect('/login');else{var hY=hW.query.q,hZ=process.env.API_KEY,iB={method:'GET',headers:{accept:'application/json',Authorization:`Bearer ${hZ}`}};var iA=`https://api.themoviedb.org/3/search/movie?query=${hY}`;fetch(iA,iB).then(iC=>iC.json()).then(iD=>{console.log(iD.results);var iE=iD.results,iF=[],iG=[],iH=[],iI=[],iJ=[],iK=[],iL=[];for(const iO of iE){var iM=iO.adult,iN=iO.backdrop_path,_L=iO.genre_ids,_M=iO.id,_N=iO.original_title,_O=iO.poster_path,_p=d(iO.title,{replacement:'-',remove:/[*+~.,()'"!:@]/g,lower:!0,strict:!1,locale:'en',trim:!0});iF.push(iM);iG.push(iN);iH.push(_L);iI.push(_M);iJ.push(_N);iK.push(_O);iL.push(_p)}hX.render('searchresults.ejs',{adultArray:iF,backdropPathArray:iG,movieGenreIds:iH,idArray:iI,originalTitleArray:iJ,posterPathArray:iK,urlTitleArray:iL})}).catch(iP=>{console.error('error:',iP);hX.status(500).send('Er is een fout opgetreden bij het verwerken van uw verzoek.')})}});j.use((iQ,iR)=>{console.error('404 error at URL: '+iQ.url);iR.status(404).send('404 error at URL: '+iQ.url)});j.use((iS,iT,iU)=>{console.error(iS.stack);iU.status(500).send('500: server error')});j.listen(process.env.PORT,()=>console.log(`Server is listening at port ${process.env.PORT}`));
