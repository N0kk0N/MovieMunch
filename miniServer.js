var{isArray:a}=Array,b=require('express'),c=require('request'),d=require('slugify'),e=require('xss'),f=require('bcrypt'),g=require('multer'),h=g.diskStorage({destination:function(A,_,B){B(null,'static/uploads')},filename:function(C,_b,_c){const D=_b.originalname.split('.').pop(),F=E.toISOString();const E=new Date();_c(null,`${C.session.users}${F}.${D}`)}}),i=g({storage:h}),j=b(),{MongoClient:k,ServerApiVersion:l,ObjectId:m}=require('mongodb');require('dotenv').config();j.use(b.urlencoded({extended:!0})).use('/static',b.static('static')).use(require('express-session')({secret:process.env.SESSION_KEY,resave:!1,saveUninitialized:!1})).set('view engine','ejs').set('views','view').listen(3000,()=>console.log('Server is running on port 3000'));var n=`${process.env.MONGODB_URL}`;var o=new k(n, {serverApi:{version:l.v1,strict:!0,deprecationErrors:!0}});o.connect().then(()=>console.log('Database connection established')).catch(_a=>{console.log(`Database connection error - ${_a}`);console.log(`For uri - ${n}`)});j.get('/',(_A,_B)=>{_B.render('homepage.ejs');console.log(_A.session.users)});j.get('/overview',(aA,aB)=>{if(aA.session.users==void 0)aB.redirect('/login');else{var _C=require('request'),_d=process.env.API_KEY,_e={28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',99:'Documentary',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Science Fiction',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'},_f=aA.session.users,G=o.db(process.env.MONGODB_NAME),H=G.collection(process.env.MONGODB_COLLECTION),I=async ()=>{try {const aC=await H.findOne({'_id':new m(_f)});const aD=aC.genre,aE=aC.rating;return{genreArray:aD,userRating:aE}} catch (aF) {console.error('Failed to retrieve favorites:',aF)}};I().then(({genreArray:aG,userRating:aH})=>_C({method:'GET', url:`https://api.themoviedb.org/3/discover/movie?api_key=process.env.API_KEY&language=en-US&sort_by=popularity.desc&vote_average.gte=${aH}&with_genres=${aG}`, qs:{language:'en-US',page:1}, headers:{accept:'application/json',Authorization:`Bearer ${_d}`}},function(aI,aJ,aK){if(aI)throw Error(aI);var _D=JSON.parse(aK).results,_E=[],_F=[],_g=[],_h=[],_i=[],J=[],K=[],L=[],M=[],N=[],O=[],p=[],q=[],r=[],s=[];for(const aT of _D){var t=aT.adult,u=aT.backdrop_path,v=aT.genre_ids.map(aU=>_e[aU]),w=aT.id,x=aT.original_language,y=aT.original_title,z=aT.overview,aL=aT.popularity,aM=aT.poster_path,aN=aT.release_date,aO=aT.title,aP=d(aT.title,{replacement:'-',remove:/[*+~.,()'"!:@]/g,lower:!0,strict:!1,locale:'en',trim:!0}),aQ=aT.video,aR=aT.vote_average,aS=aT.vote_count;_E.push(t);_F.push(u);_g.push(v);_h.push(w);_i.push(x);J.push(y);K.push(z);L.push(aL);M.push(aM);N.push(aN);O.push(aO);p.push(aP);q.push(aQ);r.push(aR);s.push(aS)}aB.render('overview.ejs',{adultArray:_E,backdropPathArray:_F,genreIdsArray:_g,idArray:_h,originalLanguageArray:_i,originalTitleArray:J,overviewArray:K,popularityArray:L,posterPathArray:M,releaseDateArray:N,titleArray:O,videoArray:q,voteAverageArray:r,voteCountArray:s,urlTitleArray:p})}))}});j.get('/overview/all',(aV,aW)=>{if(aV.session.users==void 0)aW.redirect('/login');else{var aX=require('request'),aY=process.env.API_KEY,aZ=aV.session.users,bA=o.db(process.env.MONGODB_NAME),_G=bA.collection(process.env.MONGODB_COLLECTION),_H=async ()=>{try {const bB=await _G.findOne({'_id':new m(aZ)});const bC=bB.genre,bD=bB.rating;return{genreArray:bC,userRating:bD}} catch (bE) {console.error('Failed to retrieve favorites:',bE)}};_H().then(({genreArray:bF,userRating:bG})=>{var bH=[],bI=[],bJ=[],bK=[],bL=[],bM=[],_I=[],_j=[],_k=[],_l=[],_m=[],_n=[],_o=[],P=[],Q=[];let R=1;function S(){aX({method:'GET', url:`https://api.themoviedb.org/3/discover/movie?api_key=process.env.API_KEY&language=en-US&sort_by=popularity.desc&vote_average.gte=${bG}&with_genres=${bF}`, qs:{language:'en-US',page:R}, headers:{accept:'application/json',Authorization:`Bearer ${aY}`}},function(bN,bO,bP){if(bN)throw Error(bN);var bQ=JSON.parse(bP).results;for(const bS of bQ){bH.push(bS.adult);bI.push(bS.backdrop_path);bJ.push(bS.genre_ids);bK.push(bS.id);bL.push(bS.original_language);bM.push(bS.original_title);_I.push(bS.overview);_j.push(bS.popularity);_k.push(bS.poster_path);_l.push(bS.release_date);_m.push(bS.title);_n.push(bS.video);_o.push(bS.vote_average);P.push(bS.vote_count);var bR=d(bS.title,{replacement:'-',remove:/[*+~.,()'"!:@]/g,lower:!0,strict:!1,locale:'en',trim:!0});Q.push(bR)}R++;R<=10?S():T()})}function T(){aW.render('overviewAll.ejs',{adultArray:bH,backdropPathArray:bI,genreIdsArray:bJ,idArray:bK,originalLanguageArray:bL,originalTitleArray:bM,overviewArray:_I,popularityArray:_j,posterPathArray:_k,releaseDateArray:_l,titleArray:_m,videoArray:_n,voteAverageArray:_o,voteCountArray:P,urlTitleArray:Q})}S()})}});j.get('/favourites',(bT,bU)=>{if(bT.session.users==void 0)bU.redirect('/login');else{var bV=bT.session.users,bW=o.db(process.env.MONGODB_NAME),bX=bW.collection(process.env.MONGODB_COLLECTION),bY=async ()=>{try {const bZ=await bX.findOne({'_id':new m(bV)});return bZ.favorites||[]} catch (cA) {console.error('Failed to retrieve favorites:',cA);return[]}};bY().then(cB=>{var cC=[],cD=[],cE=[],cG=cB.length;let cF=0;!cG&&bU.render('favourites.ejs',{idArray:cC,posterPathArray:cD,titleArray:cE});for(const cJ of cB){var cH=process.env.API_KEY,cI={method:'GET',url:`https://api.themoviedb.org/3/movie/${cJ}?language=en-US`,qs:{language:'en-US',page:1},headers:{accept:'application/json',Authorization:`Bearer ${cH}`}};c(cI,function(cK,cL,cM){if(cK){console.error('Error fetching movie data:',cK);return}var cN=JSON.parse(cM);cC.push(cN.id);cD.push(cN.poster_path);cE.push(cN.title);cF++;cF==cG&&bU.render('favourites.ejs',{idArray:cC,posterPathArray:cD,titleArray:cE})})}}).catch(cO=>{console.error('Error while retrieving favorites:',cO);bU.status(500).send('Internal server error')})}});j.get('/signup',(cP,cQ)=>{cQ.render('signup.ejs');console.log(cP.session.users)});j.get('/signup/preferences',(cR,cS)=>{cS.render('signup-preferences.ejs');console.log(cR.session.users)});j.get('/login',(cT,cU)=>{cU.render('login.ejs');console.log(cT.session.users)});j.get('/profile',(cV,cW)=>{if(cV.session.users==void 0)cW.redirect('/login');else{var cX=cV.session.users,cY=o.db(process.env.MONGODB_NAME),cZ=cY.collection(process.env.MONGODB_COLLECTION),dA=async ()=>{try {const dB=await cZ.findOne({'_id':new m(cX)});const dC=dB.fileName,dD=dB.username,dE=dB.genre,dF=dB.rating;console.log(`dit is de picture filename: ${dC}`);console.log(`dit is de username: ${dD}`);console.log(`dit is de genres: ${dE}`);return{pictureFilename:dC,username:dD,genres:dE,rating:dF}} catch (dG) {console.error('Failed to retrieve favorites:',dG)}};dA().then(({pictureFilename:dH,username:dI,genres:dJ,rating:dK})=>cW.render('profile.ejs',{pictureFilename:dH,username:dI,genres:dJ,rating:dK})).catch(()=>cW.status(500).send('Internal Server Error'));console.log(cV.session.users)}});j.get('/searchmovie',(dL,dM)=>dM.render('searchmovie.ejs'));j.get('/profile/settings',(dN,dO)=>{if(dN.session.users==void 0)dO.redirect('/login');else{var dP=dN.session.users,dQ=o.db(process.env.MONGODB_NAME),dR=dQ.collection(process.env.MONGODB_COLLECTION),dS=async ()=>{try {const dT=await dR.findOne({'_id':new m(dP)});const dU=dT.fileName,dV=dT.username,dW=dT.genre,dX=dT.rating;return{pictureFilename:dU,username:dV,genres:dW,rating:dX}} catch (dY) {console.error('Failed to retrieve favorites:',dY)}};dS().then(({pictureFilename:dZ,username:eA,genres:eB,rating:eC})=>dO.render('profile-settings.ejs',{pictureFilename:dZ,username:eA,genres:eB,rating:eC}));console.log(dN.session.users)}});j.post('/profile-picture',i.single('avatar'),async function(eD,eE){var eF=o.db(process.env.MONGODB_NAME),eG=eF.collection(process.env.MONGODB_COLLECTION),eH=eD.body.rating,eI=e(eD.body.username),eJ=eD.body.genre;try {var eK=await eG.findOne({'_id':new m(eD.session.users)});var eL={'rating':eH,'username':eI||eK.username,'genre':eJ?(a(eJ)?eJ:[eJ]):eK.genre};let eM=eD.file?eD.file.filename:null;eM?eL.fileName=eM:eL.fileName=eK.fileName;if(eI&&eI!==eK.username){var _J=await eG.findOne({username:e(eD.body.username)});if(_J)return eE.render('username-exists.ejs',{initialDetailPageURL:eD.headers.referer})}await eG.findOneAndUpdate({'_id':new m(eD.session.users)},{$set:eL});eE.render('profile-updated.ejs',{initialDetailPageURL:eD.headers.referer})} catch (eN) {console.error(eN);eE.status(500).send('Server error')}});j.get('/movie/:name',async (eO,eP)=>{if(eO.session.users==void 0)eP.redirect('/login');else{movieName=eO.params.name;var eR=`https://api.themoviedb.org/3/search/movie?query=${movieName}&language=en-US`;var eQ=process.env.API_KEY,eS={method:'GET',headers:{accept:'application/json',Authorization:`Bearer ${eQ}`}};fetch(eR,eS).then(eT=>eT.json()).then(eU=>{var eV=eU.results[0],eW=eV.genre_ids,eX=[],eY={28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',99:'Documentary',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Science Fiction',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'},eZ=eV.id,fA=eV.overview,fB=eV.poster_path,fC=eV.release_date,fD=eV.title;for(const fE of eW)eX.push(eY[fE]);fetch(`https://api.themoviedb.org/3/movie/${eZ}?language=en-US`,{method:'GET',headers:{accept:'application/json',Authorization:`Bearer ${eQ}`}}).then(fF=>fF.json()).then(fG=>{var fH=fG.runtime,fI=fG.production_countries[0].name,fJ={'Algeria':'African','Angola':'African','Benin':'African','Botswana':'African','Burkina Faso':'African','Burundi':'African','Canada':'American','Central African Republic':'African','Comoros':'African','Congo':'African','Djibouti':'African','Equatorial Guinea':'African','Eritrea':'African','Ethiopia':'African','Gabon':'African','Gambia':'African','Ghana':'African','Guinea':'African','Guinea-Bissau':'African','Ivory Coast':'African','Cape Verde':'African','Cameroon':'African','Kenya':'African','Lesotho':'African','Liberia':'African','Madagascar':'African','Malawi':'African','Mali':'African','Mauritania':'African','Mauritius':'African','Mozambique':'African','Namibia':'African','Niger':'African','Nigeria':'African','Uganda':'African','Rwanda':'African','Sao Tome and Principe':'African','Senegal':'African','Seychelles':'African','Sierra Leone':'African','Somalia':'African','Sudan':'African','South Africa':'African','South Sudan':'African','Swaziland':'African','Tanzania':'African','Togo':'African','Chad':'African','Zambia':'African','Zimbabwe':'African','Indonesia':'Asian','Pakistan':'Asian','Bangladesh':'Asian','Philippines':'Asian','Afghanistan':'Asian','Saudi Arabia':'Asian','Uzbekistan':'Asian','Malaysia':'Asian','New Zealand':'Asian','Yemen':'Asian','Nepal':'Asian','Sri Lanka':'Asian','Kazakhstan':'Asian','Syria':'Asian','Cambodia':'Asian','Jordan':'Asian','Azerbaijan':'Asian','United Arab Emirates':'Asian','Tajikistan':'Asian','Laos':'Asian','Kyrgyzstan':'Asian','Turkmenistan':'Asian','Singapore':'Asian','Oman':'Asian','State of Palestine':'Asian','Kuwait':'Asian','Georgia':'Asian','Mongolia':'Asian','Armenia':'Asian','Qatar':'Asian','Bahrain':'Asian','Taiwan':'Asian','Timor-Leste':'Asian','United States of America':'American','United Kingdom':'British','Antigua and Barbuda':'Caribbean','The Bahamas':'Caribbean','Barbados':'caribbean','Cuba':'caribbean','Curaçao':'caribbean','Dominica':'caribbean','Dominican Republic':'caribbean','Grenada':'Caribbean','Haiti':'caribbean','Jamaica':'Caribbean','Saint Kitts and Nevis':'Caribbean','Saint Lucia':'Caribbean','Saint Vincent and the Grenadines':'Caribbean','Trinidad and Tobago':'Caribbean','China':'CHinese','Belarus':'Eastern European','Bulgaria':'Eastern European','Czech Republic':'Eastern European','Estonia':'Eastern European','Hungary':'Eastern European','Latvia':'Eastern European','Lithuania':'Eastern European','Moldova':'Eastern European','Poland':'Eastern European','Romania':'Eastern European','Russia':'Eastern European','Slovakia':'Eastern European','Ukraine':'Eastern European','Andorra':'European','Austria':'European','Belgium':'European','Denmark':'European','Finland':'European','Iceland':'European','Luxembourg':'European','Malta':'European','Monaco':'European','Netherlands':'European','Norway':'European','Portugal':'European','San Marino':'European','Sweden':'European','Switzerland':'European','Vatican City':'European','France':'French','Germany':'German','Greece':'Greek','India':'Indian','Ireland':'Irish','Italy':'Italian','Japan':'Japanese','Israel':'Jewish','South Korea':'Korean','North Korea':'Korean','Argentina':'Latin American','Belize':'Latin American','Bolivia':'Latin American','Brazil':'Latin American','Chile':'Latin American','Colombia':'Latin American','Costa Rica':'Latin American','Ecuador':'Latin American','El Salvador':'Latin American','Guatemala':'Latin American','Guyana':'Latin American','Honduras':'Latin American','Mexico':'Latin American','Nicaragua':'Latin American','Panama':'Latin American','Paraguay':'Latin American','Peru':'Latin American','Suriname':'Latin American','Uruguay':'Latin American','Venezuela':'Latin American','Vietnam':'Vietnamese'};if(fJ.hasOwnProperty(fI)){var fK=fJ[fI],fL=process.env.FOOD_API_KEY,fM=~~Math.random()*100;var fN=`https://api.spoonacular.com/recipes/complexSearch?cuisine=${fK}&number=1&offset=${fM}&apiKey=${fL}`;fetch(fN).then(fO=>{if(!fO.ok)throw Error(`Network response was not ok: ${fO.status}`);return fO.json()}).then(fP=>{var fQ=fP.results[0].id,fR=fP.results[0].title,fS=process.env.FOOD_API_KEY;fetch(`https://api.spoonacular.com/recipes/${fQ}/analyzedInstructions?apiKey=${fL}`).then(fT=>{if(!fT.ok)throw Error(`Network response was not ok: ${fT.status}`);return fT.json()}).then(fU=>{var fV=[],fW=[],fX=fU[0].steps;for(const fY of fX){fV.push(fY.number);fW.push(fY.step)}fetch(`https://api.spoonacular.com/recipes/${fQ}/ingredientWidget.json?apiKey=${fS}`).then(fZ=>{if(!fZ.ok)throw Error(`Network response was not ok: ${fZ.status}`);return fZ.json()}).then(gA=>{var gB=gA.ingredients,gC=[],gD=[],gE=[];for(const gF of gB){gC.push(gF.name);gD.push(gF.amount.metric.value);gE.push(gF.amount.metric.unit)}(async ()=>{var gG=eO.session.users,gH=o.db(process.env.MONGODB_NAME),gI=gH.collection(process.env.MONGODB_COLLECTION);try {var gJ=await gI.findOne({'_id':new m(gG)});var gK=gJ.favorites,gL=gK.map(gN=>parseInt(gN,10));let gM;gL.includes(eZ)?(gM=!0,eP.render('filmdescription.ejs',{movieGenres:eW,movieId:eZ,movieOverview:fA,moviePosterPath:fB,movieReleaseDate:fC,movieTitle:fD,inList:gM,recipeTitle:fR,stepNumberArray:fV,stepOverviewArray:fW,ingredientNameArray:gC,ingredientValueArray:gD,ingredientUnitArray:gE,movieGenresClean:eX,movieRuntime:fH})):(gM=!1,eP.render('filmdescription.ejs',{movieGenres:eW,movieId:eZ,movieOverview:fA,moviePosterPath:fB,movieReleaseDate:fC,movieTitle:fD,inList:gM,recipeTitle:fR,stepNumberArray:fV,stepOverviewArray:fW,ingredientNameArray:gC,ingredientValueArray:gD,ingredientUnitArray:gE,movieGenresClean:eX,movieRuntime:fH}))} catch (gO) {console.error('Failed to retrieve favorites:',gO)}})()})})})}else console.log(`Er is geen keukeninformatie beschikbaar voor ${fI}.`)}).catch(gP=>console.error(`error:${gP}`))}).catch(gQ=>console.error(`error:${gQ}`))}});j.post('/favorite-deleted',(gR,gS)=>{var gT=gR.session.users,gU=gR.body.favoriteBtn,gV=o.db(process.env.MONGODB_NAME),gW=gV.collection(process.env.MONGODB_COLLECTION);(async ()=>{try {var gX=await gW.findOne({'_id':new m(gT)});var gY=gX.favorites,gZ=gY.filter(hA=>`${hA}`!==`${gU}`);await gW.updateOne({'_id':new m(gT)},{$set:{'favorites':gZ}})} catch (hB) {console.error('Failed to retrieve favorites:',hB)}})();gS.render('delete-confirmation.ejs',{initialDetailPageURL:gR.headers.referer})});j.post('/favorite-added',(hC,hD)=>{var hE=o.db(process.env.MONGODB_NAME);(async ()=>{})();hD.render('add-confirmation.ejs',{initialDetailPageURL:hC.headers.referer})});j.get('/logout',(hF,hG)=>hF.session.destroy(hH=>hH?(console.error(hH),hG.status(500).send('Session destroy failed')):(hG.redirect('/login'))));j.post('/new-user',async (hI,hJ)=>{var hK=o.db(process.env.MONGODB_NAME),hL=hK.collection(process.env.MONGODB_COLLECTION);try {var hM=await hL.findOne({username:e(hI.body.username)});if(!hM){var hN=10;var hO=await hL.findOne({username:e(hI.body.username)});hI.session.users=hO._id;hJ.redirect('/overview')}else hJ.render('username-exists.ejs',{initialDetailPageURL:hI.headers.referer})} catch (hP) {console.error(hP);hJ.status(500).send('Server error')}});j.post('/login-confirmation',async (hQ,hR)=>{try {var hS=o.db(process.env.MONGODB_NAME),hT=hS.collection(process.env.MONGODB_COLLECTION);var hU=await hT.findOne({username:e(hQ.body.username)});if(hU){var hV=await f.compare(hQ.body.password,hU.password);hV?(hQ.session.users=hU._id,hR.redirect('/overview'),console.log(hQ.session.users)):(hR.render('invalid-password.ejs',{initialDetailPageURL:hQ.headers.referer}))}else hR.render('user-doenst-exist.ejs',{initialDetailPageURL:hQ.headers.referer})} catch (hW) {console.error(hW);hR.status(500).send('Server error')}});j.get('/search',(hX,hY)=>{if(hX.session.users==void 0)hY.redirect('/login');else{var hZ=hX.query.q,iA=process.env.API_KEY,iC={method:'GET',headers:{accept:'application/json',Authorization:`Bearer ${iA}`}};var iB=`https://api.themoviedb.org/3/search/movie?query=${hZ}`;fetch(iB,iC).then(iD=>iD.json()).then(iE=>{console.log(iE.results);var iF=iE.results,iG=[],iH=[],iI=[],iJ=[],iK=[],iL=[],iM=[];for(const iO of iF){var iN=iO.adult,_K=iO.backdrop_path,_L=iO.genre_ids,_M=iO.id,_N=iO.original_title,_O=iO.poster_path,_p=d(iO.title,{replacement:'-',remove:/[*+~.,()'"!:@]/g,lower:!0,strict:!1,locale:'en',trim:!0});iG.push(iN);iH.push(_K);iI.push(_L);iJ.push(_M);iK.push(_N);iL.push(_O);iM.push(_p)}hY.render('searchresults.ejs',{adultArray:iG,backdropPathArray:iH,movieGenreIds:iI,idArray:iJ,originalTitleArray:iK,posterPathArray:iL,urlTitleArray:iM})}).catch(iP=>{console.error('error:',iP);hY.status(500).send('Er is een fout opgetreden bij het verwerken van uw verzoek.')})}});j.use((iQ,iR)=>{console.error('404 error at URL: '+iQ.url);iR.status(404).send('404 error at URL: '+iQ.url)});j.use((iS,iT,iU)=>{console.error(iS.stack);iU.status(500).send('500: server error')});j.listen(process.env.PORT,()=>console.log(`Server is listening at port ${process.env.PORT}`));
